<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload Video - All in 1st</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
    .upload-card { background: white; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-bold text-primary" href="watch.html">All in 1st</a>
      <div class="d-flex">
        <a href="watch.html" class="btn btn-outline-primary">
          <i class="bi bi-arrow-left me-2"></i>Back to Watch
        </a>
      </div>
    </div>
  </nav>

  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="upload-card p-5">
          <div class="text-center mb-4">
            <i class="bi bi-cloud-upload text-primary" style="font-size: 3rem;"></i>
            <h2 class="mt-3">Upload Your Video</h2>
            <p class="text-muted">Share your manga explainer content with the community</p>
          </div>

          <div id="alert"></div>

          <form id="uploadForm">
            <div class="mb-4">
              <label class="form-label fw-bold">Video Title <span class="text-danger">*</span></label>
              <input type="text" id="title" class="form-control form-control-lg" placeholder="Enter video title..." required>
            </div>

            <div class="mb-4">
              <label class="form-label fw-bold">YouTube Video Link <span class="text-danger">*</span></label>
              <input type="url" id="youtubeLink" class="form-control form-control-lg" placeholder="https://www.youtube.com/watch?v=..." required>
              <div class="form-text">
                <i class="bi bi-info-circle me-1"></i>
                Paste the full YouTube URL here. We'll extract the video ID automatically.
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="mb-4">
                  <label class="form-label fw-bold">Genre</label>
                  <select id="genre" class="form-select form-select-lg">
                    <option value="Action">Action</option>
                    <option value="Adventure">Adventure</option>
                    <option value="Comedy">Comedy</option>
                    <option value="Drama">Drama</option>
                    <option value="Fantasy">Fantasy</option>
                    <option value="Horror">Horror</option>
                    <option value="Romance">Romance</option>
                    <option value="Sci-Fi">Sci-Fi</option>
                    <option value="Slice of Life">Slice of Life</option>
                    <option value="Supernatural">Supernatural</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-4">
                  <label class="form-label fw-bold">Tags</label>
                  <input type="text" id="tags" class="form-control form-control-lg" placeholder="Action, Shounen, Epic...">
                  <div class="form-text">Separate tags with commas</div>
                </div>
              </div>
            </div>

            <div class="mb-4">
              <label class="form-label fw-bold">Description</label>
              <textarea id="description" class="form-control" rows="4" placeholder="Describe your video content, key points covered, and what viewers can expect..."></textarea>
            </div>

            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-primary btn-lg">
                <i class="bi bi-cloud-upload me-2"></i>
                <span id="submitText">Upload Video</span>
                <div class="spinner-border spinner-border-sm ms-2 d-none" id="uploadSpinner"></div>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Check if user is logged in
    function getSession() {
      try {
        return JSON.parse(localStorage.getItem('allin1st_session') || sessionStorage.getItem('allin1st_session') || 'null');
      } catch (e) {
        return null;
      }
    }

    function isLoggedIn() {
      const session = getSession();
      return session && session.isLoggedIn === true;
    }

    // Redirect if not logged in
    if (!isLoggedIn()) {
      window.location.href = 'login.html?next=upload.html';
    }

    const currentUser = getSession();

    function showAlert(message, type = 'danger') {
      document.getElementById('alert').innerHTML = 
        `<div class="alert alert-${type} alert-dismissible fade show">
          <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
    }

    function extractYouTubeId(url) {
      const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
      const match = url.match(regExp);
      return (match && match[7].length === 11) ? match[7] : null;
    }

    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const title = document.getElementById('title').value.trim();
      const youtubeLink = document.getElementById('youtubeLink').value.trim();
      const genre = document.getElementById('genre').value;
      const tagsInput = document.getElementById('tags').value.trim();
      const description = document.getElementById('description').value.trim();

      // Validation
      if (!title) {
        showAlert('Please enter a video title.');
        return;
      }

      if (!youtubeLink) {
        showAlert('Please enter a YouTube link.');
        return;
      }

      const youtubeId = extractYouTubeId(youtubeLink);
      if (!youtubeId) {
        showAlert('Please enter a valid YouTube URL.');
        return;
      }

      // Show loading state
      const submitText = document.getElementById('submitText');
      const spinner = document.getElementById('uploadSpinner');
      submitText.textContent = 'Uploading...';
      spinner.classList.remove('d-none');

      // Simulate upload delay
      await new Promise(resolve => setTimeout(resolve, 2000));

      try {
        // Process tags
        const tags = tagsInput ? tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag) : [];

        // Create video object
        const newVideo = {
          id: Date.now(), // Use timestamp as unique ID
          title: title,
          description: description || '',
          genre: genre,
          youtubeId: youtubeId,
          tags: tags,
          uploadDate: new Date().toISOString(),
          uploader: currentUser.username
        };

        // Get existing uploads
        const existingUploads = JSON.parse(localStorage.getItem('videosUploaded') || '[]');
        
        // Add new video to the beginning
        existingUploads.unshift(newVideo);
        
        // Save back to localStorage
        localStorage.setItem('videosUploaded', JSON.stringify(existingUploads));

        console.log('Video uploaded successfully:', newVideo);
        console.log('All uploads:', existingUploads);

        // Show success message
        showAlert('Video uploaded successfully! Redirecting to watch page...', 'success');

        // Reset form
        document.getElementById('uploadForm').reset();

        // Redirect to watch page after 2 seconds
        setTimeout(() => {
          window.location.href = 'watch.html';
        }, 2000);

      } catch (error) {
        console.error('Upload error:', error);
        showAlert('An error occurred while uploading. Please try again.');
        
        // Reset button state
        submitText.textContent = 'Upload Video';
        spinner.classList.add('d-none');
      }
    });

    // Auto-fill demo data (for testing)
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey && e.shiftKey && e.key === 'D') {
        document.getElementById('title').value = 'Test Manga Explainer';
        document.getElementById('youtubeLink').value = 'https://www.youtube.com/watch?v=dQw4w9WgXcQ';
        document.getElementById('genre').value = 'Action';
        document.getElementById('tags').value = 'Test, Demo, Action';
        document.getElementById('description').value = 'This is a test video upload for demonstration purposes.';
      }
    });
  </script>
</body>
</html>
